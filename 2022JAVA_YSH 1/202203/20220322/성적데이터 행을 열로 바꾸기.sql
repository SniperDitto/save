CREATE TABLE SCORES
(
    STU_ID           CHAR(4)     NOT NULL,
    SUB_ID           CHAR(4)     NOT NULL,
    SCORE           NUMBER(5)   NOT NULL,
    CONSTRAINT SCORES_PK PRIMARY KEY(STU_ID, SUB_ID)
);

INSERT INTO SCORES VALUES('ST01','SU01',90.14);
INSERT INTO SCORES VALUES('ST01','SU02',88.16);
INSERT INTO SCORES VALUES('ST01','SU03',90.55);
INSERT INTO SCORES VALUES('ST01','SU04',55.90);

INSERT INTO SCORES VALUES('ST02','SU01',67.98);
INSERT INTO SCORES VALUES('ST02','SU02',89.57);
INSERT INTO SCORES VALUES('ST02','SU03',91.56);
INSERT INTO SCORES VALUES('ST02','SU04',92.78);

INSERT INTO SCORES VALUES('ST03','SU01',92.90);
INSERT INTO SCORES VALUES('ST03','SU02',88.98);
INSERT INTO SCORES VALUES('ST03','SU03',67.09);
INSERT INTO SCORES VALUES('ST03','SU04',90.56);

INSERT INTO SCORES VALUES('ST04','SU01',98.12);
INSERT INTO SCORES VALUES('ST04','SU02',77.45);
INSERT INTO SCORES VALUES('ST04','SU03',81.56);

INSERT INTO SCORES VALUES('ST05','SU01',78.67);
INSERT INTO SCORES VALUES('ST05','SU02',88.56);
INSERT INTO SCORES VALUES('ST05','SU04',78.12);

--COMMIT;

CREATE TABLE STUDENTS
(
    STU_ID      CHAR(4)     PRIMARY KEY,
    STU_NAME    VARCHAR2(30)    NOT NULL
);

INSERT INTO STUDENTS VALUES('ST01', '최국수');
INSERT INTO STUDENTS VALUES('ST02', '김도우');
INSERT INTO STUDENTS VALUES('ST03', '도길유');
INSERT INTO STUDENTS VALUES('ST04', '김길순');
INSERT INTO STUDENTS VALUES('ST05', '강도인');

--COMMIT;

CREATE TABLE SUBJECTS
(
    SUB_ID      CHAR(4)     PRIMARY KEY,
    SUB_NAME    VARCHAR2(30)   NOT NULL
);

INSERT INTO SUBJECTS VALUES('SU01', '국어');
INSERT INTO SUBJECTS VALUES('SU02', '수학');
INSERT INTO SUBJECTS VALUES('SU03', '영어');
INSERT INTO SUBJECTS VALUES('SU04', '과학');

--COMMIT;

SELECT D.STU_ID, D.STU_NAME, 
          MAX(KOR) AS KOR,
          MAX(MATH) AS MATH,
          MAX(ENG) AS ENG,
          MAX(SCI) AS SCI,
          AVG(TLTSCORE) AS TLTSCORE, AVG(AVGSCORE) AS AVGSCO
FROM
(
SELECT 
    A.STU_ID, A.STU_NAME,
    DECODE(A.SUB_ID, 'SU01', NVL(B.SCORE, 0), 0) AS KOR,
    DECODE(A.SUB_ID, 'SU02', NVL(B.SCORE, 0), 0) AS MATH,
    DECODE(A.SUB_ID, 'SU03', NVL(B.SCORE, 0), 0) AS ENG,
    DECODE(A.SUB_ID, 'SU04', NVL(B.SCORE, 0), 0) AS SCI,
    SUM(NVL(B.SCORE,0)) OVER(PARTITION BY A.STU_ID) AS TLTSCORE,
    ROUND(AVG(NVL(B.SCORE,0)) OVER(PARTITION BY A.STU_ID),2) AS AVGSCORE
    FROM
    (
        SELECT T1.STU_ID, T1.STU_NAME, T2.SUB_ID, T2.SUB_NAME
        FROM STUDENTS T1, SUBJECTS T2
    ) A, SCORES B
    WHERE A.STU_ID = B.STU_ID(+) AND A.SUB_ID = B.SUB_ID(+)
) D
GROUP BY D.STU_ID, D.STU_NAME
ORDER BY D.STU_ID
;